-----------------------------------------------------------------------------------
       log:  C:\Documents and Settings\Steph Cellini\My Documents\Research\BondTest
> \Stata\test_makeshortpanel.log
  log type:  text
 opened on:  25 Oct 2008, 12:05:31

. 
. # delimit;
delimiter now ;
. version 9.0;

. set more off;

. clear;

. **** This program updates Jesse's program to run the short panel analysis on the 
> test score data;
. **** Steph Cellini;
. **** Updated July 1, 2008;
. /************************************************************
> * makeshortpanel.do
> * Jesse Rothstein
> * April 28, 2008
> *
> * Prepare data for the "short panel" analysis, treating each 
> * measure as a separate event and analyzing data for several years
> * before and after (ignoring overlap in the windows)
> * Modified, June 26, 2008:
> *    1) Extend measures data back to 1987 (there are a couple in 1986,
> *       but it looks as if most are missing).
> *    2) Modify "bad observation" processing to deal with a couple of
> *       measures where "percent" is missing or "req" is incorrect in
> *       early years.
> *    3) Change code to select GO Bonds over parcel taxes as a higher
> *       priority than selecting on the vote share when multiple measures
> *       occur in the same year.
> *
> * HISTORY:
> * Based on:
> * graphs.do
> *    By Francisco Perez Arce Novaro
> *    July 31, 2007
> *
> *    Generates scatter plots of vote share and financial variables, as well as en
> rollment.
> *    Uses data created by newleaidsforleafinancepanel.do (in this directory)
> *    the dataset used is "newleaidsforleafinancepanel.dta (in this directory)
> *    Creates gphs, stored in a subfolder of this directory (raw)
> *    to run this program: place this do file in the same directory as "newleaidsf
> orleafinancepanel.dta
> *    and open two subfolders in this directory with names: "raw" and "graphs"
> * prepdata.do (in spending\march2008 directory)
> *    Updated:
> *    8/1/2007, by fpan:  added these comments
> *    8/2/2007, by fpan: created cumulative variables and cumulative graphs
> *    8/8/2007, by fpan: changed censors for some variables;
> *    8/13/2007 by fpan: changed censors for some variables;
> *    8/20/2007 by fpan: created `v'_to for year==-2;
> *
> 
> **************************************************************/;
. set mem 100m;

Current memory allocation

                    current                                 memory usage
    settable          value     description                 (1M = 1024k)
    --------------------------------------------------------------------
    set maxvar         5000     max. variables allowed           1.733M
    set memory          100M    max. data space                100.000M
    set matsize         400     max. RHS vars in models          1.254M
                                                            -----------
                                                               102.987M

. cd "C:\Documents and Settings\Steph Cellini\My Documents\Research\BondTest\";
C:\Documents and Settings\Steph Cellini\My Documents\Research\BondTest

. *Get the measure data ready;
.  *use "t:\projects\caelections\houseprices\fromfernando\referenda_newleaids_capit
> al.dta";
.  use "Data\referenda_newleaids_capital.dta";

. rename year yearref;

.  *note: we are replacing calendar year with schoolyear;
.   replace yearref = yearref - 1 if month<5;
(598 real changes made)

.   label var yearref "schoolyear starting yr of elec.";

.  *change req threshold and type in one election, look at :\\coauthor\referenda_gr
> aphing_RDD.do for details;
.   replace req="M" if newleaid=="0615180" & yearref==1992;
(1 real change made)

.   replace election_type="Other" if newleaid=="0615180" & yearref==1992;
(1 real change made)

.  *Select sample;
.   *Keep only measures since 1995;
.    *keep if yearref>=1995;
.   *Keep only measures since 1987;
.    keep if yearref>=1987;
(72 observations deleted)

.   *Keep only GO Bonds and parcel taxes;
.    keep if election_type== "GO Bond"  | election_type=="Parcel Tax";
(88 observations deleted)

.    gen gobond=(election_type=="GO Bond");

.    gen parcel_cap=(capitaloutlays=="Y")*(gobond==0);

.   *Identify measures where percent, passfail, and req dont all match;
.    gen mv=percent-req_num;
(11 missing values generated)

.    gen badobs=(mv>=0 & mv<. & passfail=="F");

.    replace badobs=1 if mv<0 & passfail=="P";
(1 real change made)

.    replace badobs=1 if mv==.;
(11 real changes made)

.    count if badobs==1 & percent<.;
    1

.    assert r(N)==1;

.    count if badobs==1 & percent==.;
   11

.    replace percent=. if badobs==1;
(1 real change made, 1 to missing)

.    label var mv "voteshare-based MARGIN of VICTORY";

.   *If there are multiple measures that meet these criteria, keep winning over los
> ing measures
>   *and then keep only the highest vote share.  Break ties by (1) GO over parcel (
> 2) lowest requirement.;
.    gen win=(passfail=="P") if badobs~=1;
(12 missing values generated)

.    gen fakewin=(percent>=66.7) if percent<. & req_num<=56;
(1285 missing values generated)

.    replace fakewin=(percent>=55) if percent<. & req_num>=66 & req_num<.;
(1273 real changes made)

.    assert req_num<=56 | req_num>=66;

.    label var fakewin "Indicator for pass at counterfactual threshold";

.    gsort newleaid yearref badobs -gobond -win -percent req_num ;

.    by newleaid yearref: gen numelec=_N;

.    by newleaid yearref: gen numbad=sum(badobs);

.    by newleaid yearref: replace badobs=(numbad[_N]>0);
(1 real change made)

.    by newleaid yearref: keep if _n==1;
(128 observations deleted)

.    label var numelec "# of GO/parcel elecs in same year";

.  *We only need a few variables;
.   keep newleaid yearref percent win fakewin req_num numelec gobond parcel_cap;

.   rename req_num req;

.  *Form counts of measures per district since 1983;
.   sort newleaid yearref;

.   by newleaid: gen measnum=_n;

.   by newleaid: gen nummeas=_N;

.   label var measnum "Measure number (chronological) in district";

.   label var nummeas "Number of measures in district in sample";

.   tab measnum;

    Measure |
     number |
(chronologi |
    cal) in |
   district |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        656       42.21       42.21
          2 |        423       27.22       69.43
          3 |        238       15.32       84.75
          4 |        123        7.92       92.66
          5 |         62        3.99       96.65
          6 |         31        1.99       98.65
          7 |         14        0.90       99.55
          8 |          6        0.39       99.94
          9 |          1        0.06      100.00
------------+-----------------------------------
      Total |      1,554      100.00

.   tab nummeas if measnum==nummeas;

  Number of |
measures in |
district in |
     sample |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        233       35.52       35.52
          2 |        185       28.20       63.72
          3 |        115       17.53       81.25
          4 |         61        9.30       90.55
          5 |         31        4.73       95.27
          6 |         17        2.59       97.87
          7 |          8        1.22       99.09
          8 |          5        0.76       99.85
          9 |          1        0.15      100.00
------------+-----------------------------------
      Total |        656      100.00

.   su measnum, meanonly;

.   local maxnmeas=r(max);

. tempfile referenda referenda_wide;

.  sort newleaid yearref;

.  gen refid=_n;

.  save `referenda';
file C:\DOCUME~1\STEPHC~1\LOCALS~1\Temp\ST_05000002.tmp saved

. *Make counts of referenda to date and victories to date;
. use `referenda';

. gen meastodate=measnum;

. by newleaid (yearref): gen winstodate=sum(win);

. keep newleaid year meastodate winstodate;

. fillin newleaid year;

. sort newleaid year;

. by newleaid: replace meastodate=0 if _n==1 & _fillin;
(610 real changes made)

. by newleaid: replace winstodate=0 if _n==1 & _fillin;
(610 real changes made)

. by newleaid: replace meastodate=meastodate[_n-1] if meastodate==.;
(10956 real changes made)

. by newleaid: replace winstodate=winstodate[_n-1] if winstodate==.;
(10956 real changes made)

. drop _fillin;

. sort newleaid yearref;

. rename yearref year;

. tempfile refs2date;

. save `refs2date';
file C:\DOCUME~1\STEPHC~1\LOCALS~1\Temp\ST_05000009.tmp saved

. *********** Merging *****************;
. *Merge to the test score data, and make leads and lags of the referenda variables
> ;
. * First, I merge on the old api data;
. * This has the parental education variables;
.  use "Data/tscoresall";

. *Merge on the new (better) test score data for reading and math;
.  sort newleaid year;

.  merge newleaid year using "Data/readmath_new";

.  tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         48        0.39        0.39
          2 |        477        3.86        4.25
          3 |     11,818       95.75      100.00
------------+-----------------------------------
      Total |     12,343      100.00

. * API score had obs for special ed schools, but reading and math don't (but they 
> do have offices of education);
. * Keeping all of them anyway;
. drop _merge;

. * Trying dropping data before 1997 to avoid missing years;
. * I think all works better;
. * keep if year>=1997;
.  sort newleaid year;

.  merge newleaid year using `refs2date', unique;

.  sort newleaid year;

.  by newleaid: replace meastodate=0 if _merge==1 & _n==1;
(402 real changes made)

.  by newleaid: replace winstodate=0 if _merge==1 & _n==1;
(402 real changes made)

.  by newleaid: replace meastodate=meastodate[_n-1] if _merge==1 & _n>1;
(4117 real changes made)

.  by newleaid: replace winstodate=winstodate[_n-1] if _merge==1 & _n>1;
(4117 real changes made)

.  drop _merge;

.  sort newleaid year;

. *Fill in measures/wins for observations pre test score;
.   fillin newleaid year;

.   sort newleaid year;

.   by newleaid: replace meastodate=0 if _n==1 & meastodate==.;
(402 real changes made)

.   by newleaid: replace winstodate=0 if _n==1 & winstodate==.;
(402 real changes made)

.   by newleaid: replace meastodate=meastodate[_n-1] if _n>1 & meastodate==.;
(3119 real changes made)

.   by newleaid: replace winstodate=winstodate[_n-1] if _n>1 & winstodate==.;
(3119 real changes made)

.  tempfile testdat;

.  save `testdat';
file C:\DOCUME~1\STEPHC~1\LOCALS~1\Temp\ST_0500000f.tmp saved

. *Another set of outcome variables is the presence of an initiative on the ballot;
.  use `referenda';

.  keep newleaid year gobond parcel_cap win;

.  rename gobond isgobond;

.  rename parcel_cap isparcelcap;

.  gen byte ismeasure=1;

.  rename win iswin;

.  label var isgobond "Is a GO Bond on ballot this yr?";

.  label var ismeasure "Is any Bond/parcel tax on ballot this yr?";

.  label var isparcelcap "Is a parcel tax w/capital on ballot this yr?";

.  label var iswin "Did measure on ballot win?";

.  fillin newleaid year;

.  foreach v of varlist isgobond isparcelcap ismeasure iswin {;
  2.         replace `v'=0 if _fillin==1;
  3.  };
(11566 real changes made)
(11566 real changes made)
(11566 real changes made)
(11566 real changes made)

.  drop _fillin;

.  rename yearref year;

.  sort newleaid year;

.  merge newleaid year using `testdat', unique;
year was int now float

.  tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      8,040       38.00       38.00
          3 |     13,120       62.00      100.00
------------+-----------------------------------
      Total |     21,160      100.00

.  foreach v of varlist isgobond isparcelcap ismeasure iswin {;
  2.         replace `v'=0 if _merge==2;
  3.  };
(8040 real changes made)
(8040 real changes made)
(8040 real changes made)
(8040 real changes made)

.  drop _merge;

.  sort newleaid year;

.  joinby newleaid using `referenda', unmatched(none);

.  gen dyear=year-yearref;

.  tab dyear, m;

      dyear |      Freq.     Percent        Cum.
------------+-----------------------------------
        -19 |        111        0.36        0.36
        -18 |        154        0.50        0.85
        -17 |        249        0.80        1.65
        -16 |        359        1.16        2.81
        -15 |        459        1.48        4.29
        -14 |        568        1.83        6.11
        -13 |        648        2.08        8.20
        -12 |        741        2.38       10.58
        -11 |        827        2.66       13.24
        -10 |        961        3.09       16.34
         -9 |      1,036        3.33       19.67
         -8 |      1,110        3.57       23.24
         -7 |      1,165        3.75       26.99
         -6 |      1,231        3.96       30.95
         -5 |      1,294        4.16       35.11
         -4 |      1,383        4.45       39.56
         -3 |      1,425        4.58       44.15
         -2 |      1,460        4.70       48.84
         -1 |      1,508        4.85       53.70
          0 |      1,554        5.00       58.70
          1 |      1,443        4.64       63.34
          2 |      1,400        4.50       67.84
          3 |      1,305        4.20       72.04
          4 |      1,195        3.84       75.89
          5 |      1,095        3.52       79.41
          6 |        986        3.17       82.58
          7 |        906        2.92       85.50
          8 |        813        2.62       88.11
          9 |        727        2.34       90.45
         10 |        593        1.91       92.36
         11 |        518        1.67       94.03
         12 |        444        1.43       95.46
         13 |        389        1.25       96.71
         14 |        323        1.04       97.75
         15 |        260        0.84       98.58
         16 |        171        0.55       99.13
         17 |        129        0.42       99.55
         18 |         94        0.30       99.85
         19 |         46        0.15      100.00
------------+-----------------------------------
      Total |     31,080      100.00

. *** Note that Jesse uses [-2, 6], but Fernando may be using [-3, 6];
. *** Be sure to create lags for it below as well and change them back for 2;
.  keep if dyear>=-2 & dyear<=6;
(19134 observations deleted)

.  *Make squared, cubed, etc. vars;
.  gen percent2=percent^2;
(90 missing values generated)

.  gen percent3=percent^3;
(90 missing values generated)

.  *Make leads and lags;
.   foreach v in percent percent2 percent3 win fakewin req numelec gobond parcel_ca
> p {;
  2.    forvalues dy=1/2 {;
  3.     gen `v'_m`dy'=`v'*(dyear==-`dy');
  4.     };
  5.    forvalues dy=0/6 {;
  6.     gen `v'_`dy'=`v'*(dyear==`dy');
  7.    };
  8.    *drop `v';
.   };
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)
(90 missing values generated)

. *** To get a consistent sample for reading and math (they are off by one obs);
. drop if sstd_catread3==. & sstd_catmath3!=.;
(2 observations deleted)

.         save "Data/test_shortpanel.dta", replace;
file Data/test_shortpanel.dta saved

. log close;
       log:  C:\Documents and Settings\Steph Cellini\My Documents\Research\BondTest
> \Stata\test_makeshortpanel.log
  log type:  text
 closed on:  25 Oct 2008, 12:05:35
-----------------------------------------------------------------------------------
