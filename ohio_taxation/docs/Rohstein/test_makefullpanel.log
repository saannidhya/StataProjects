------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\parentor\OneDrive - University of Cincinnati\workingpapers\RD\codes\Rohstein\test_makefullpanel.log
  log type:  text
 opened on:  16 Jul 2024, 13:02:46

. 
. # delimit;
delimiter now ;
. version 9.0;

. set more off;

. clear;

. **** This program updates Jesse's "makefullpanel" for use with Test Score data;
. **** Steph Cellini 
> **** updated July 1, 2008 with new test score data;
. /************************************************************
> * makefullpanel.do
> * Jesse Rothstein
> * April 10, 2008
> * Prepare data for the "full" analysis, using all district-year observations and with all leads and
> * lags of the election variables.
> *
> * Modified, June 26, 2008:
> *    1) Extend measures data back to 1987 (there are a couple in 1986,
> *       but it looks as if most are missing).
> *    2) Modify "bad observation" processing to deal with a couple of
> *       measures where "percent" is missing or "req" is incorrect in
> *       early years.
> *    3) Change code to select GO Bonds over parcel taxes as a higher
> *       priority than selecting on the vote share when multiple measures
> *       occur in the same year.
> * HISTORY:
> * Based on:
> * graphs.do
> *    By Francisco Perez Arce Novaro
> *    July 31, 2007
> *
> *    Generates scatter plots of vote share and financial variables, as well as enrollment.
> *    Uses data created by newleaidsforleafinancepanel.do (in this directory)
> *    the dataset used is "newleaidsforleafinancepanel.dta (in this directory)
> *    Creates gphs, stored in a subfolder of this directory (raw)
> *    to run this program: place this do file in the same directory as "newleaidsforleafinancepanel.dta
> *    and open two subfolders in this directory with names: "raw" and "graphs"
> * prepdata.do (in spending\march2008 directory)
> *    Updated:
> *    8/1/2007, by fpan:  added these comments
> *    8/2/2007, by fpan: created cumulative variables and cumulative graphs
> *    8/8/2007, by fpan: changed censors for some variables;
> *    8/13/2007 by fpan: changed censors for some variables;
> *    8/20/2007 by fpan: created `v'_to for year==-2;
> *
> 
> **************************************************************/
> 
> 
> 
> 
> set mem 100m;

. local projectbase "C:\Users\parentor\OneDrive - University of Cincinnati\workingpapers\RD\codes\Rohstein\";

. cd "C:\Users\parentor\OneDrive - University of Cincinnati\workingpapers\RD\codes\Rohstein\";
C:\Users\parentor\OneDrive - University of Cincinnati\workingpapers\RD\codes\Rohstein

. *Get the measure data ready;
.  use "`projectbase'\referenda_newleaids_capital.dta";

.  rename year yearref;

.  *note: we are replacing calendar year with schoolyear;
.   replace yearref = yearref - 1 if month<5;
(598 real changes made)

.   label var yearref "schoolyear starting yr of elec.";

.  *change req threshold and type in one election, look at :\\coauthor\referenda_graphing_RDD.do for details;
.   replace req="M" if newleaid=="0615180" & yearref==1992;
(1 real change made)

.   replace election_type="Other" if newleaid=="0615180" & yearref==1992;
(1 real change made)

.  *Select sample;
.   *Keep only measures since 1995;
.    *keep if yearref>=1995;
.   *Keep only measures since 1987;
.    keep if yearref>=1987;
(72 observations deleted)

.   *Keep only GO Bonds and parcel taxes;
.    keep if election_type== "GO Bond"  | election_type=="Parcel Tax";
(88 observations deleted)

.    gen gobond=(election_type=="GO Bond");

.    gen parcel_cap=(capitaloutlays=="Y")*(gobond==0);

.   *Identify measures where percent, passfail, and req dont all match;
.    gen mv=percent-req_num;
(11 missing values generated)

.    gen badobs=(mv>=0 & mv<. & passfail=="F");

.    replace badobs=1 if mv<0 & passfail=="P";
(1 real change made)

.    replace badobs=1 if mv==.;
(11 real changes made)

.    count if badobs==1 & percent<.;
  1

.    assert r(N)==1;

.    count if badobs==1 & percent==.;
  11

.    replace percent=. if badobs==1;
(1 real change made, 1 to missing)

.    label var mv "voteshare-based MARGIN of VICTORY";

.   *If there are multiple measures that meet these criteria, keep winning over losing measures
>   *and then keep only the highest vote share.  Break ties by (1) lowest requirement (2) GO over parcel.;
.    gen win=(passfail=="P");

.    gsort newleaid yearref badobs -gobond -win -percent req_num ;

.    by newleaid yearref: gen numelec=_N;

.    by newleaid yearref: gen numbad=sum(badobs);

.    by newleaid yearref: replace badobs=(numbad[_N]>0);
(1 real change made)

.    by newleaid yearref: keep if _n==1;
(128 observations deleted)

.    label var numelec "# of GO/parcel elecs in same year";

.    gen fakewin=(percent>=66.7) if percent<. & req_num<=56;
(1,168 missing values generated)

.    replace fakewin=(percent>=55) if percent<. & req_num>=66 & req_num<.;
(1,158 real changes made)

.    assert req_num<=56 | req_num>=66;

.    label var fakewin "Indicator for pass at counterfactual threshold";

.  *We only need a few variables;
.   keep newleaid yearref percent win req_num numelec gobond parcel_cap fakewin;

.   rename req_num req;

.  *Form counts of measures per district since 1983;
.   sort newleaid yearref;

.   by newleaid: gen measnum=_n;

.   by newleaid: gen nummeas=_N;

.   label var measnum "Measure number (chronological) in district";

.   label var nummeas "Number of measures in district in sample";

.   tab measnum;

    Measure |
     number |
(chronologi |
    cal) in |
   district |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        656       42.21       42.21
          2 |        423       27.22       69.43
          3 |        238       15.32       84.75
          4 |        123        7.92       92.66
          5 |         62        3.99       96.65
          6 |         31        1.99       98.65
          7 |         14        0.90       99.55
          8 |          6        0.39       99.94
          9 |          1        0.06      100.00
------------+-----------------------------------
      Total |      1,554      100.00

.   tab nummeas if measnum==nummeas;

  Number of |
measures in |
district in |
     sample |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        233       35.52       35.52
          2 |        185       28.20       63.72
          3 |        115       17.53       81.25
          4 |         61        9.30       90.55
          5 |         31        4.73       95.27
          6 |         17        2.59       97.87
          7 |          8        1.22       99.09
          8 |          5        0.76       99.85
          9 |          1        0.15      100.00
------------+-----------------------------------
      Total |        656      100.00

.   su measnum, meanonly;

.   local maxnmeas=r(max);

. tempfile referenda referenda_wide;

.  sort newleaid yearref;

.  save `referenda';
file C:\Users\parentor\AppData\Local\Temp\ST_3fac_000001.tmp saved

.  reshape wide yearref percent win fakewin req numelec gobond parcel_cap, i(newleaid) j(measnum);
(note: j = 1 2 3 4 5 6 7 8 9)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                     1554   ->     656
Number of variables                  11   ->      74
j variable (9 values)           measnum   ->   (dropped)
xij variables:
                                yearref   ->   yearref1 yearref2 ... yearref9
                                percent   ->   percent1 percent2 ... percent9
                                    win   ->   win1 win2 ... win9
                                fakewin   ->   fakewin1 fakewin2 ... fakewin9
                                    req   ->   req1 req2 ... req9
                                numelec   ->   numelec1 numelec2 ... numelec9
                                 gobond   ->   gobond1 gobond2 ... gobond9
                             parcel_cap   ->   parcel_cap1 parcel_cap2 ... parcel_cap9
-----------------------------------------------------------------------------

.  sort newleaid;

.  save `referenda_wide';
file C:\Users\parentor\AppData\Local\Temp\ST_3fac_000002.tmp saved

. *Make counts of referenda to date and victories to date;
. use `referenda';

. gen meastodate=measnum;

. by newleaid (yearref): gen winstodate=sum(win);

. keep newleaid year meastodate winstodate;

. fillin newleaid year;

. sort newleaid year;

. by newleaid: replace meastodate=0 if _n==1 & _fillin;
(610 real changes made)

. by newleaid: replace winstodate=0 if _n==1 & _fillin;
(610 real changes made)

. by newleaid: replace meastodate=meastodate[_n-1] if meastodate==.;
(10956 real changes made)

. by newleaid: replace winstodate=winstodate[_n-1] if winstodate==.;
(10956 real changes made)

. drop _fillin;

. sort newleaid yearref;

. rename yearref year;

. tempfile refs2date;

. save `refs2date';
file C:\Users\parentor\AppData\Local\Temp\ST_3fac_000003.tmp saved

. ********** Merging **********;
. *Merge to the test score data, and make leads and lags of the referenda variables;
. * First I add on the old api score data (this has parental education data);
.  use "tscoresall";
file tscoresall.dta not found
r(601);

end of do-file

r(601);

. exit, clear
