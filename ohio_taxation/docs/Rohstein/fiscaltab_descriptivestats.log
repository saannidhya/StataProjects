-------------------------------------------------------------------------------------------------------------------------
       log:  C:\Documents and Settings\Jesse Rothstein\My Documents\projects\caelections\archive\fiscaltab_descriptivesta
> ts.log
  log type:  text
 opened on:   6 Mar 2010, 13:14:58

. 
. *Program to compute estimates for Table 2:  Summary statistics for
. * - All districts
. * - Districts that never proposed a measure
. * - Districts that ever proposed a measure
. * - Districts that passed a measure
. * - Districts that failed a measure.
. * Items 1-3 will pool all available years.  Items 4-5 use year t-1.
. 
. #delimit;
delimiter now ;
. clear;

. set mem 100m;

Current memory allocation

                    current                                 memory usage
    settable          value     description                 (1M = 1024k)
    --------------------------------------------------------------------
    set maxvar         5000     max. variables allowed           1.909M
    set memory          100M    max. data space                100.000M
    set matsize         400     max. RHS vars in models          1.254M
                                                            -----------
                                                               103.163M

. *local projectbase "t:\projects\caelections";
. *local projectbase "/Volumes/Dept/WWS/Research/Rothstein/projects/caelections";
. *Start by grabbing all districts and merging on the "ever propose" indicator;
.  use "referenda_newleaids_capital.dta";

.  rename year yearref;

.  replace yearref = yearref - 1 if month<5;
(598 real changes made)

.  label var yearref "schoolyear starting yr of elec.";

.   *Keep only measures since 1987;
.    keep if yearref>=1987;
(72 observations deleted)

.   *Keep only GO Bonds;
.    keep if election_type== "GO Bond";
(451 observations deleted)

.  sort newleaid yearref;

.  *Make two versions:  One a list of elections, one of districts with elections;
.   assert passfail=="P" | passfail=="F";

.   gen win=(passfail=="P");

.   *For list of elections, need to eliminate duplicates;
.     *Identify measures where percent, passfail, and req dont all match;
.      gen mv=percent-req_num;

.      gen badobs=(mv>=0 & mv<. & passfail=="F");

.      replace badobs=1 if mv<0 & passfail=="P";
(2 real changes made)

.      replace badobs=1 if mv==.;
(0 real changes made)

.      count if badobs==1 & percent<.;
    2

.      count if badobs==1 & percent==.;
    0

.      replace percent=. if badobs==1;
(2 real changes made, 2 to missing)

.      label var mv "voteshare-based MARGIN of VICTORY";

.     *If there are multiple measures that meet these criteria, keep winning over losing measures
>     *and then keep only the highest vote share.  Break ties by (1) lowest requirement (2) GO over parcel.;
.      gsort newleaid yearref badobs -win -percent req_num ;

.      by newleaid yearref: keep if _n==1;
(87 observations deleted)

.   keep newleaid yearref win;

.   assert win<.;

.   sort newleaid yearref;

.   tempfile oneref;

.   save `oneref';
file C:\DOCUME~1\JESSER~1\LOCALS~1\Temp\ST_00000085.tmp saved

.   by newleaid: keep if _n==1;
(598 observations deleted)

.   gen hasany=1;

.   sort newleaid;

.   keep newleaid hasany;

.   tempfile everref;

.   save `everref';
file C:\DOCUME~1\JESSER~1\LOCALS~1\Temp\ST_00000086.tmp saved

. *Now grab the finance data - only districts with > 50 observations!;
.  use if v33>50 using financepanel;

.  sort newleaid year;

.  merge newleaid using `everref', uniqusing;
variable newleaid does not uniquely identify observations in the master data

.  tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      3,306       32.41       32.41
          2 |          5        0.05       32.45
          3 |      6,891       67.55      100.00
------------+-----------------------------------
      Total |     10,202      100.00

.  list newleaid if _merge==2;

       +----------+
       | newleaid |
       |----------|
10198. |  0625150 |
10199. |  0630250 |
10200. |  0635600 |
10201. |  0635830 |
10202. |       NA |
       +----------+

.  drop if _merge==2;
(5 observations deleted)

.  drop _merge;

.  replace hasany=0 if hasany==.;
(3306 real changes made)

.  *Identify election outcomes in following year;
.   gen yearref=year+1;

.   sort newleaid yearref;

.   merge newleaid yearref using `oneref', unique;

.   tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      9,353       88.36       88.36
          2 |        388        3.67       92.03
          3 |        844        7.97      100.00
------------+-----------------------------------
      Total |     10,585      100.00

.   drop if _merge==2;
(388 observations deleted)

.   drop _merge;

. *Clean up some variables;
.  gen dltdebt=_41f-_19h;

.  gen dstdebt=_66v-_61v;

.  *note: this generates a column of ceros;
.  *note: checking back, since leafinane_panel_ca those variables were only zeros;
.   rename _21f ltdebtiss;

.   rename _31f ltdebtret;

.   rename _41f ltdebt;

.   rename i86 interest;

.   rename t06 locproptax;

.   rename v40 curexp_oper;

.   rename v45 curexp_xport;

.   rename v60 curexp_entop;

.   rename f12 cap_constr;

.   rename g15 cap_land;

.   gen cap_equip=k09+k10+k11;

.   rename z33 instrsal;

. *Current non-instructional expenditure:
> *(Total current elem/sec - instructional) + total non-elem/sec
> * Excludes the following that are otherwise included in total expenditures:
> * L12: Payments to state governments
> * M12: Payments to local governments
> * Q11: Payments to other school systems
> * I86: Interest on debt;
.  gen tcurnoninst=tcurelsc-tcurinst+tnonelse;

. foreach v of varlist tcapout tcurelsc totalexp tcurinst dltdebt ltdebtiss ltdebtret ltdebt interest
>              locproptax curexp_oper curexp_xport curexp_entop cap_constr cap_land cap_equip instrsal
>              tstrev tfedrev c11 c12 c01 c13 c35 tcurnoninst {;
  2.  *Convert to real 2000$, using "West" CPI for 1st half of yr;
.   qui replace `v'=`v'*174.8/152.9 if year==1995;
  3.   qui replace `v'=`v'*174.8/156.6 if year==1996;
  4.   qui replace `v'=`v'*174.8/160.6 if year==1997;
  5.   qui replace `v'=`v'*174.8/163.6 if year==1998;
  6.   qui replace `v'=`v'*174.8/167.8 if year==1999;
  7.   qui replace `v'=`v'*174.8/173.1 if year==2000;
  8.   qui replace `v'=`v'*174.8/180.2 if year==2001;
  9.   qui replace `v'=`v'*174.8/184.0 if year==2002;
 10.   qui replace `v'=`v'*174.8/188.2 if year==2003;
 11.   qui replace `v'=`v'*174.8/191.9 if year==2004;
 12.   qui replace `v'=`v'*174.8/197.1 if year==2005;
 13.   qui replace `v'=`v'*174.8/204.5 if year==2006;
 14.   qui replace `v'=`v'*174.8/210.890 if year==2007;
 15.         qui gen `v'_pp=`v'/v33;
 16.   *Truncate top & bottom 1% of each;
.    qui su `v'_pp, d;
 17.    replace `v'_pp=r(p1) if `v'_pp<r(p1);
 18.    replace `v'_pp=r(p99) if `v'_pp>r(p99) & `v'_pp<.;
 19.  };
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(0 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(101 real changes made)
(0 real changes made)
(0 real changes made)
(101 real changes made)
(101 real changes made)

.  gen lnenroll=ln(v33);

. *Add together state and federal revenue;
.  gen tstfedrev_pp=tstrev_pp+tfedrev_pp;

. *Now, can make the table for cols 1-3;
.  sort newleaid year;

.  by newleaid: gen firstobs=(_n==1);

.  gen isobs=1;

.  tabstat firstobs isobs ltdebt_pp totalexp_pp tcapout_pp tcurinst_pp tstfedrev_pp lnenroll,
>          statistics(mean sd n) by(hasany) columns(statistics) longstub;

hasany       variable |      mean        sd         N
----------------------+------------------------------
0            firstobs |  .0964912  .2953084      3306
                isobs |         1         0      3306
            ltdebt_pp |  479.4174  1793.461      3306
          totalexp_pp |  7409.602  2292.573      3306
           tcapout_pp |  679.4956  905.1023      3306
          tcurinst_pp |   4033.87  941.4662      3306
         tstfedrev_pp |  4958.487  1791.443      3306
             lnenroll |  6.180293  1.433947      3306
----------------------+------------------------------
1            firstobs |  .0912785  .2880256      6891
                isobs |         1         0      6891
            ltdebt_pp |  2706.014  3581.405      6891
          totalexp_pp |  7493.417  2119.476      6891
           tcapout_pp |    1037.8  1163.939      6891
          tcurinst_pp |  3843.539  727.8773      6891
         tstfedrev_pp |  4308.986  1596.531      6891
             lnenroll |  8.029618  1.468069      6891
----------------------+------------------------------
Total        firstobs |  .0929685  .2904026     10197
                isobs |         1         0     10197
            ltdebt_pp |  1984.123  3285.804     10197
          totalexp_pp |  7466.243  2177.345     10197
           tcapout_pp |   921.633  1099.617     10197
          tcurinst_pp |  3905.247  808.2492     10197
         tstfedrev_pp |  4519.562  1689.719     10197
             lnenroll |  7.430043  1.694789     10197
-----------------------------------------------------

. *And for cols 4-5;
.  drop firstobs;

.  keep if win<.;
(9353 observations deleted)

.  sort newleaid year;

.  by newleaid: gen firstobs=(_n==1);

.  tabstat firstobs isobs ltdebt_pp totalexp_pp tcapout_pp tcurinst_pp tstfedrev_pp lnenroll,
>          statistics(mean sd n) by(win) columns(statistics) longstub;

win          variable |      mean        sd         N
----------------------+------------------------------
0            firstobs |  .6422018  .4804555       218
                isobs |         1         0       218
            ltdebt_pp |  1247.112   2388.14       218
          totalexp_pp |  6941.073  1921.288       218
           tcapout_pp |  934.9644  1112.081       218
          tcurinst_pp |  3618.321  677.4387       218
         tstfedrev_pp |  4222.544  1266.462       218
             lnenroll |  8.094604    1.4791       218
----------------------+------------------------------
1            firstobs |  .6485623  .4778011       626
                isobs |         1         0       626
            ltdebt_pp |  1736.045  3072.216       626
          totalexp_pp |  7289.794  1898.262       626
           tcapout_pp |  881.6557  1005.286       626
          tcurinst_pp |  3824.039  703.2827       626
         tstfedrev_pp |  4242.161  1563.845       626
             lnenroll |  8.342675  1.484377       626
----------------------+------------------------------
Total        firstobs |  .6469194  .4782109       844
                isobs |         1         0       844
            ltdebt_pp |  1609.757  2917.473       844
          totalexp_pp |  7199.722  1909.211       844
           tcapout_pp |   895.425  1033.515       844
          tcurinst_pp |  3770.903  702.1052       844
         tstfedrev_pp |  4237.094  1492.019       844
             lnenroll |    8.2786  1.486116       844
-----------------------------------------------------

. log close;
       log:  C:\Documents and Settings\Jesse Rothstein\My Documents\projects\caelections\archive\fiscaltab_descriptivesta
> ts.log
  log type:  text
 closed on:   6 Mar 2010, 13:15:02
-------------------------------------------------------------------------------------------------------------------------
