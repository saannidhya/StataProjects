----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:/Users/rawatsa/OneDrive - University of Cincinnati/StataProjects/ohio_taxation/code/ohio_road_housing_census_merge.txt
  log type:  text
 opened on:  30 Jul 2022, 15:50:25

. 
. * defining lists/scalars;
. scalar cutoff = 50

. 
. *importing tax levies dataset (also contains census info);
. use "${data}/roads_levies2_census_9118.dta", clear

. sort TENDIGIT_FIPS year

. 
. *storing a snapshot (to restore later, if needed);
. preserve

. 
. * keeping only the required variables (using vars in Dr. Brasington's email: see email on 07/08/2022, 8:13am)
. keep year pop TENDIGIT_FIPS TENDIGIT_FIPS_year childpov poverty pctwithkids pctsinparhhld pctnokids pctlesshs pcthsgrad pctsomecoll pctbachelors pctgraddeg unemprate medfamy pctrent pctown pctlt5 pct5to17 pct18to64 pct65pls 
> pctwhite pctblack pctamerind pctapi pctotherrace pctmin raceherfindahl pcthisp pctmarried pctnevermarr pctseparated pctdivorced lforcepartrate incherfindahl inctaxrate tax_type purpose2 description millage_percent duration v
> otes_for votes_against 

. 
. *calculating votes_pct_for and votes_pct_for_cntr
. generate votes_pct_for = (votes_for / (votes_for + votes_against))*100

. generate votes_pct_for_cntr = abs(votes_pct_for - cutoff)

. 
. *---------------------------------------------------------------------------------------------;
. *       filtering to remove dups                                                                                                                                  ;
. *---------------------------------------------------------------------------------------------;
. 
. *1st type of filter: keep observations closest to cutoff;
. sort TENDIGIT_FIPS year votes_pct_for_cntr

. quietly by TENDIGIT_FIPS year: gen dup = cond(_N==1, 0, _n)

. drop if dup > 1
(485 observations deleted)

. drop dup

. 
. * creating new year variables: t+1, ...., t+10. Merge will be done based on these variables
. foreach t of numlist -2/-1 1/10 {
  2.         if `t' < 0 {
  3.                 local t_abs = abs(`t')
  4.                 generate yr_t_minus_`t_abs' = year + `t'
  5.         }
  6.         else {
  7.                 generate yr_t_plus_`t' = year + `t'     
  8.         }
  9. }

. 
. order TENDIGIT_FIPS year yr_t_minus_1 yr_t_minus_2 yr_t_plus_1-yr_t_plus_10, first

. // keep TENDIGIT_FIPS year yr_t_plus_1-yr_t_plus_10
. 
. * saving after filtering
. save "${data}/roads_and_census.dta", replace
file C:/Users/rawatsa/OneDrive - University of Cincinnati/StataProjects/ohio_taxation/data/roads_and_census.dta saved

. 
. 
. *---------------------------------------------------------------------------------------------------------;
. *       Merging housing and roads (using TENDIGIT_FIPS and year variable : t periods ahead and behind)            ;
. *---------------------------------------------------------------------------------------------------------;
. 
. *importing housing sales data;
. foreach t of numlist -2/-1 1/10 {
  2.         clear all 
  3.         use "${shared}\housesales_9521_slim.dta", clear
  4.         order TENDIGIT_FIPS year, first
  5.         sort TENDIGIT_FIPS year
  6.         scalar cutoff = 50      
  7.         
.         *creating sale_amount per square feet variable;
.         generate SALE_AMOUNT_per_sq_feet = SALE_AMOUNT/universal_building_square_feet
  8.         
.         if `t' < 0 {
  9.                 local t_abs = abs(`t')
 10.                 rename year yr_t_minus_`t_abs'
 11. 
.                 *destring TENDIGIT_FIPS and year (converting into numeric) before merging;
.                 destring TENDIGIT_FIPS yr_t_minus_`t_abs', replace
 12.                 recast float yr_t_minus_`t_abs'
 13. 
.                 * merging with roads and census data;
.                 merge m:1 TENDIGIT_FIPS yr_t_minus_`t_abs' using "${data}/roads_and_census.dta"
 14.                 
.                 * re-generating centered variable to avoid absolute value sign
.                 drop votes_pct_for_cntr
 15.                 generate votes_pct_for_cntr = votes_pct_for - cutoff            
 16.                 
.                 * saving dataset with matches and non-matches;
.                 save "${shared}\housing_roads_census_t_minus_`t_abs'.dta", replace 
 17.                 keep if _merge == 3
 18.                 save "${shared}\housing_roads_census_t_minus_`t_abs'_matches.dta", replace              
 19.         }
 20.         else {
 21.                 rename year yr_t_plus_`t'
 22. 
.                 *destring TENDIGIT_FIPS and year (converting into numeric) before merging;
.                 destring TENDIGIT_FIPS yr_t_plus_`t', replace
 23.                 recast float yr_t_plus_`t'
 24.                 format %10.0f TENDIGIT_FIPS
 25. 
.                 * merging with roads and census data;
.                 merge m:1 TENDIGIT_FIPS yr_t_plus_`t' using "${data}/roads_and_census.dta"
 26.                 
.                 * re-generating centered variable to avoid absolute value sign
.                 drop votes_pct_for_cntr
 27.                 generate votes_pct_for_cntr = votes_pct_for - cutoff
 28.                 
.                 * saving dataset with matches and non-matches;
.                 save "${shared}\housing_roads_census_t_plus_`t'.dta", replace   
 29.                 keep if _merge == 3
 30.                 save "${shared}\housing_roads_census_t_plus_`t'_matches.dta", replace           
 31.         }       
 32.         
. }
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_minus_2: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,842,873
        from master                 6,842,669  (_merge==1)
        from using                        204  (_merge==2)

    Matched                           303,170  (_merge==3)
    -----------------------------------------
(6,842,669 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_minus_2.dta saved
(6,842,873 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_minus_2_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_minus_1: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,820,181
        from master                 6,820,033  (_merge==1)
        from using                        148  (_merge==2)

    Matched                           325,806  (_merge==3)
    -----------------------------------------
(6,820,033 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_minus_1.dta saved
(6,820,181 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_minus_1_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_1: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,772,881
        from master                 6,772,762  (_merge==1)
        from using                        119  (_merge==2)

    Matched                           373,077  (_merge==3)
    -----------------------------------------
(6,772,762 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_1.dta saved
(6,772,881 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_1_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_2: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,752,411
        from master                 6,752,315  (_merge==1)
        from using                         96  (_merge==2)

    Matched                           393,524  (_merge==3)
    -----------------------------------------
(6,752,315 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_2.dta saved
(6,752,411 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_2_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_3: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,754,069
        from master                 6,753,971  (_merge==1)
        from using                         98  (_merge==2)

    Matched                           391,868  (_merge==3)
    -----------------------------------------
(6,753,971 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_3.dta saved
(6,754,069 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_3_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_4: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,754,296
        from master                 6,754,044  (_merge==1)
        from using                        252  (_merge==2)

    Matched                           391,795  (_merge==3)
    -----------------------------------------
(6,754,044 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_4.dta saved
(6,754,296 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_4_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_5: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,760,123
        from master                 6,759,742  (_merge==1)
        from using                        381  (_merge==2)

    Matched                           386,097  (_merge==3)
    -----------------------------------------
(6,759,742 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_5.dta saved
(6,760,123 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_5_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_6: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,769,410
        from master                 6,768,862  (_merge==1)
        from using                        548  (_merge==2)

    Matched                           376,977  (_merge==3)
    -----------------------------------------
(6,768,862 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_6.dta saved
(6,769,410 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_6_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_7: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,777,048
        from master                 6,776,329  (_merge==1)
        from using                        719  (_merge==2)

    Matched                           369,510  (_merge==3)
    -----------------------------------------
(6,776,329 missing values generated)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_7.dta saved
(6,777,048 observations deleted)
file \\cobshares.uccob.uc.edu\economics$\Julia\roads\housing_roads_census_t_plus_7_matches.dta saved
(2,517,252 missing values generated)
TENDIGIT_FIPS: all characters numeric; replaced as double
yr_t_plus_8: all characters numeric; replaced as int
(859782 missing values generated)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     6,796,994
        from master                 6,796,093  (_merge==1)
        from using                        901  (_merge==2)

    Matched                           349,746  (_merge==3)
    -----------------------------------------
